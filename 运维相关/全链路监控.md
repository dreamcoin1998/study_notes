[toc]

# 方案概述与比较

### 背景

随着微服务架构的流行，服务按照不同的维度去拆分，一次请求往往要涉及到多个服务。因此就需要一些可以帮助理解系统行为，用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。

想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作。

在复杂的微服务架构中，几乎每一个前端的请求都会形成一个复杂的分布式服务调用链路。

- 如何快速发现问题？
- 如何判断故障影响范围？
- 如何梳理服务依赖以及依赖的合理性？
- 如何分析链路性能问题以及实时容量规划？

**关注各项性能指标，包括*吞吐量、响应时间、错误记录***

全链路监控从整体维度到局部维度展示各项性能指标

有了这项工具，我们能够达到：

- 请求链路追踪，故障快速定位
- 可视化
- 依赖优化
- 数据分析，优化链路

### 目标要求

全链路监控组件有哪些目标要求：

- 探针的性能消耗
  - APM组件服务的影响应该做到最小。使用配置采样率对一部分请求去分析路径。
- 代码的侵入性
  - 即也作为业务组件，尽可能少入侵或无入侵其他业务系统，对于使用方透明，减少开发人员负担
- 可拓展性
  - 必须支持分布式部署，具备良好的可拓展性
- 数据的分析
  - 数据的分析要快，分析的维度尽可能多

### 功能模块

一般的全链路监控系统，可分为四个功能模块：

- 埋点与生成日志
  - 埋点即系统当前上下文信息，可分为客户端埋点、服务端埋点、以及客户端和服务端双向型埋点。通常日志通常要包含以下内容：tranceID、spanID、调用的开始时间、协议类型、调用方IP和端口、请求的服务名、调用结果、异常信息等，同时预留拓展字段，为下一步拓展做准备
  - 不造成性能负担
  - 要写log、业务QPS越高，性能影响越重，通过采样和异步log解决
- 收集和存储日志
  - 主要支持分布式日志采集的方案，同时增加MQ作为缓冲
- 分析统计调用链路数据，以及时效性
  - 调用链跟踪分析：把同一TranceID的SPan收集起来，按时间排序就是timeline，把ParentIP穿起来就是调用栈，抛异常或超时，在日志里打印TranceID，利用TraceID查询调用链信息，定位问题
  - 离线分析
  - 实时分析
- 展现以及决策支持

### Span

**基本工作单元**：一次链路调用创建一个span，通过一个64位ID标识它，uuid比较方便，span中包含其他信息，比如时间戳、描述信息、key-value对的tag信息等，其中parentID可以表示span调用链路来源

### Trace

类似于树结构的Span集合，表示一次完整的跟踪。*从请求到服务器开始，服务器返回response结束，跟踪每次rpc调用的耗时，存在唯一标识traceID（存储一次trace就由一个请求组成）*

### Annotation

用来记录特定时间相关信息，一个span中会有多个annotation注解描述

